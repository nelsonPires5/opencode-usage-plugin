name: Publish Package

on:
  push:
    tags:
      - 'v*' # Triggers on v1.0.0, v0.0.2-dev, etc.

permissions:
  id-token: write
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd
        with:
          install: true
          cache: true
          experimental: true

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: mise run build

      - name: Publish to npm with OIDC
        run: |
          # Use 'next' for prerelease versions (-dev, -alpha, -beta, -rc), otherwise 'latest'
          VERSION="${{ github.ref_name }}"
          if [[ "$VERSION" =~ -dev|-alpha|-beta|-rc ]]; then
            TAG="next"
            PRERELEASE_FLAG="--prerelease"
          else
            TAG="latest"
            PRERELEASE_FLAG=""
          fi

          echo "Publishing version $VERSION with tag: $TAG"
          mise run publish --tag "$TAG"
          echo "prerelease=$PRERELEASE_FLAG" >> $GITHUB_OUTPUT
        id: publish

      - name: Extract changelog notes
        id: changelog
        run: |
          VERSION="${{ github.ref_name }}"
          NOTES=$(awk '/^## v'"${VERSION#v}"'/{found=1;next} /^## /{found=0} found' CHANGELOG.md | sed '/^$/d')

          if [ -z "$NOTES" ]; then
            NOTES="Release $VERSION"
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.ref_name }}"
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes "${{ steps.changelog.outputs.notes }}" \
            ${{ steps.publish.outputs.prerelease }}
